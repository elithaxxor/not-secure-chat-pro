2025-03-04 16:35:27,925 - INFO - [!] Starting WebSocket server on ws://0.0.0.0:3001
2025-03-04 16:35:27,935 - INFO - server listening on 0.0.0.0:3001
2025-03-04 16:35:28,153 - INFO - connection rejected (426 Upgrade Required)
2025-03-04 16:35:28,153 - ERROR - opening handshake failed
Traceback (most recent call last):
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 356, in conn_handler
    await connection.handshake(
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 207, in handshake
    raise self.protocol.handshake_exc
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 138, in accept
    ) = self.process_request(request)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 233, in process_request
    raise InvalidUpgrade(
websockets.exceptions.InvalidUpgrade: invalid Connection header: keep-alive
2025-03-04 16:35:28,212 - INFO - connection rejected (426 Upgrade Required)
2025-03-04 16:35:28,214 - ERROR - opening handshake failed
Traceback (most recent call last):
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 356, in conn_handler
    await connection.handshake(
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 207, in handshake
    raise self.protocol.handshake_exc
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 138, in accept
    ) = self.process_request(request)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 233, in process_request
    raise InvalidUpgrade(2025-03-04 16:35:27,925 - INFO - [!] Starting WebSocket server on ws://0.0.0.0:3001
2025-03-04 16:35:27,935 - INFO - server listening on 0.0.0.0:3001
2025-03-04 16:35:28,153 - INFO - connection rejected (426 Upgrade Required)
2025-03-04 16:35:28,153 - ERROR - opening handshake failed
Traceback (most recent call last):
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 356, in conn_handler
    await connection.handshake(
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 207, in handshake
    raise self.protocol.handshake_exc
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 138, in accept
    ) = self.process_request(request)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 233, in process_request
    raise InvalidUpgrade(
websockets.exceptions.InvalidUpgrade: invalid Connection header: keep-alive
2025-03-04 16:35:28,212 - INFO - connection rejected (426 Upgrade Required)
2025-03-04 16:35:28,214 - ERROR - opening handshake failed
Traceback (most recent call last):
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 356, in conn_handler
    await connection.handshake(
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 207, in handshake
    raise self.protocol.handshake_exc
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 138, in accept
    ) = self.process_request(request)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 233, in process_request
    raise InvalidUpgrade(
websockets.exceptions.InvalidUpgrade: invalid Connection header: keep-alive
2025-03-04 16:41:24,564 - INFO - connection rejected (426 Upgrade Required)
2025-03-04 16:41:24,564 - ERROR - opening handshake failed
Traceback (most recent call last):
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 356, in conn_handler
    await connection.handshake(
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 207, in handshake
    raise self.protocol.handshake_exc
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 138, in accept
    ) = self.process_request(request)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 233, in process_request
    raise InvalidUpgrade(
websockets.exceptions.InvalidUpgrade: invalid Connection header: keep-alive
2025-03-04 16:41:24,634 - INFO - connection rejected (426 Upgrade Required)
2025-03-04 16:41:24,635 - ERROR - opening handshake failed
Tracebacimport asyncio
import websockets
import json
import os
import logging
import base64

# Configure logging
logging.basicConfig(
    filename='websocket.log',
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger()

class WebSocketServer:
    def __init__(self, host, port):
        self.host = host
        self.port = port
        self.clients = set()
        self.file_dir = "files"  # Directory to store uploaded files
        os.makedirs(self.file_dir, exist_ok=True)  # Create directory if it doesn't exist

    async def on_open(self, websocket):
        print("[!] Client connected")
        logger.info(f"[+] Client connected: {websocket.remote_address}")
        self.clients.add(websocket)

    async def on_message(self, websocket, message):
        try:
            data = json.loads(message)
            action = data.get("action")

            if action == "upload":
                await self.handle_upload(data)
            elif action == "download":
                await self.handle_download(websocket, data)
            elif action == "list":
                await self.handle_list(websocket)
            else:
                logger.error(f"[-] Unknown action: {action}")
        except json.JSONDecodeError as e:
            logger.error(f"[-] Invalid message format: {e}")

    async def handle_upload(self, data):
        """Handle file upload from client."""
        file_name = data.get("fileName")
        file_content = data.get("fileContent")
        if not file_name or not file_content:
            logger.error("[-] Missing file name or content")
            return

        # Decode base64 content and save to file
        try:
            file_path = os.path.join(self.file_dir, file_name)
            with open(file_path, "wb") as f:
                f.write(base64.b64decode(file_content))
            logger.info(f"[+] File uploaded: {file_name}")
        except Exception as e:
            logger.error(f"[-] Failed to save file: {e}")

    async def handle_download(self, websocket, data):
        """Handle file download request from client."""
        file_name = data.get("fileName")
        if not file_name:
            logger.error("[-] Missing file name")
            return

        file_path = os.path.join(self.file_dir, file_name)
        if not os.path.exists(file_path):
            logger.error(f"[-] File not found: {file_name}")
            return

        # Read file and send base64 content to client
        try:
            with open(file_path, "rb") as f:
                file_content = base64.b64encode(f.read()).decode("utf-8")
            response = {
                "action": "download",
                "fileName": file_name,
                "fileContent": file_content
            }
            await websocket.send(json.dumps(response))
            logger.info(f"[+] File sent: {file_name}")
        except Exception as e:
            logger.error(f"[-] Failed to read file: {e}")

    async def handle_list(self, websocket):
        """Handle file list request from client."""
        try:
            files = os.listdir(self.file_dir)
            response = {
                "action": "list",
                "files": files
            }
            await websocket.send(json.dumps(response))
            logger.info("[+] Sent file list to client")
        except Exception as e:
            logger.error(f"[-] Failed to list files: {e}")

    async def on_error(self, websocket, error):
        print(f"[-] Error: {error}")
        logger.error(f"[-] Error: {error}")

    async def on_close(self, websocket):
        print("[!] Client disconnected")
        logger.info(f"[-] Client disconnected: {websocket.remote_address}")
        self.clients.remove(websocket)

    async def handler(self, websocket, path):
        await self.on_open(websocket)
        try:
            async for message in websocket:
                await self.on_message(websocket, message)
        except websockets.ConnectionClosed:
            await self.on_close(websocket)

    async def start(self):
        print(f"[!] Starting WebSocket server on ws://{self.host}:{self.port}")
        logger.info(f"[!] Starting WebSocket server on ws://{self.host}:{self.port}")
        async with websockets.serve(self.handler, self.host, self.port):
            await asyncio.Future()  # Run forever

if __name__ == "__main__":
    server = WebSocketServer("0.0.0.0", 6969)
    asyncio.run(server.start()) self.protocol.handshake_exc
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 138, in accept
    ) = self.process_request(request)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 233, in process_request
    raise InvalidUpgrade(
websockets.exceptions.InvalidUpgrade: invalid Connection header: keep-alive
2025-03-04 16:45:45,414 - INFO - connection rejected (426 Upgrade Required)
2025-03-04 16:45:45,414 - ERROR - opening handshake failed
Traceback (most recent call last):
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 356, in conn_handler
    await connection.handshake(
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 207, in handshake
    raise self.protocol.handshake_exc
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 138, in accept
    ) = self.process_request(request)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 233, in process_request
    raise InvalidUpgrade(
websockets.exceptions.InvalidUpgrade: invalid Connection header: keep-alive
2025-03-04 16:45:45,464 - INFO - connection rejected (426 Upgrade Required)
2025-03-04 16:45:45,465 - ERROR - opening handshake failed
Traceback (most recent call last):
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 356, in conn_handler
    await connection.handshake(
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 207, in handshake
    raise self.protocol.handshake_exc
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 138, in accept
    ) = self.process_request(request)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 233, in process_request
    raise InvalidUpgrade(
websockets.exceptions.InvalidUpgrade: invalid Connection header: keep-alive
2025-03-04 16:45:45,643 - INFO - connection rejected (426 Upgrade Required)
2025-03-04 16:45:45,643 - ERROR - opening handshake failed
Traceback (most recent call last):
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 356, in conn_handler
    await connection.handshake(
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 207, in handshake
    raise self.protocol.handshake_exc
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 138, in accept
    ) = self.process_request(request)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 233, in process_request
    raise InvalidUpgrade(
websockets.exceptions.InvalidUpgrade: invalid Connection header: keep-alive
2025-03-04 16:45:45,674 - INFO - connection rejected (426 Upgrade Required)
2025-03-04 16:45:45,675 - ERROR - opening handshake failed
Traceback (most recent call last):
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 356, in conn_handler
    await connection.handshake(
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 207, in handshake
    raise self.protocol.handshake_exc
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 138, in accept
    ) = self.process_request(request)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 233, in process_request
    raise InvalidUpgrade(
websockets.exceptions.InvalidUpgrade: invalid Connection header: keep-alive
2025-03-04 16:45:53,668 - INFO - connection rejected (426 Upgrade Required)
2025-03-04 16:45:53,669 - ERROR - opening handshake failed
Traceback (most recent call last):
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 356, in conn_handler
    await connection.handshake(
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 207, in handshake
    raise self.protocol.handshake_exc
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 138, in accept
    ) = self.process_request(request)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 233, in process_request
    raise InvalidUpgrade(
websockets.exceptions.InvalidUpgrade: invalid Connection header: keep-alive
2025-03-04 16:47:20,029 - INFO - connection rejected (426 Upgrade Required)
2025-03-04 16:47:20,029 - ERROR - opening handshake failed
Traceback (most recent call last):
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 356, in conn_handler
    await connection.handshake(
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 207, in handshake
    raise self.protocol.handshake_exc
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 138, in accept
    ) = self.process_request(request)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 233, in process_request
    raise InvalidUpgrade(
websockets.exceptions.InvalidUpgrade: invalid Connection header: keep-alive
2025-03-04 16:53:17,015 - INFO - connection rejected (426 Upgrade Required)
2025-03-04 16:53:17,016 - ERROR - opening handshake failed
Traceback (most recent call last):
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 356, in conn_handler
    await connection.handshake(
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 207, in handshake
    raise self.protocol.handshake_exc
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 138, in accept
    ) = self.process_request(request)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 233, in process_request
    raise InvalidUpgrade(
websockets.exceptions.InvalidUpgrade: invalid Connection header: keep-alive
2025-03-04 16:53:17,320 - INFO - connection rejected (426 Upgrade Required)
2025-03-04 16:53:17,321 - ERROR - opening handshake failed
Traceback (most recent call last):
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 356, in conn_handler
    await connection.handshake(
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 207, in handshake
    raise self.protocol.handshake_exc
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 138, in accept
    ) = self.process_request(request)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 233, in process_request
    raise InvalidUpgrade(
websockets.exceptions.InvalidUpgrade: invalid Connection header: keep-alive
2025-03-04 16:54:33,252 - INFO - connection rejected (426 Upgrade Required)
2025-03-04 16:54:33,252 - ERROR - opening handshake failed
Traceback (most recent call last):
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 356, in conn_handler
    await connection.handshake(
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 207, in handshake
    raise self.protocol.handshake_exc
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 138, in accept
    ) = self.process_request(request)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 233, in process_request
    raise InvalidUpgrade(
websockets.exceptions.InvalidUpgrade: invalid Connection header: keep-alive
2025-03-04 16:54:34,360 - INFO - connection rejected (426 Upgrade Required)
2025-03-04 16:54:34,360 - ERROR - opening handshake failed
Traceback (most recent call last):
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 356, in conn_handler
    await connection.handshake(
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 207, in handshake
    raise self.protocol.handshake_exc
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 138, in accept
    ) = self.process_request(request)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 233, in process_request
    raise InvalidUpgrade(
websockets.exceptions.InvalidUpgrade: invalid Connection header: keep-alive
2025-03-04 16:59:55,008 - INFO - connection rejected (426 Upgrade Required)
2025-03-04 16:59:55,009 - ERROR - opening handshake failed
Traceback (most recent call last):
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 356, in conn_handler
    await connection.handshake(
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 207, in handshake
    raise self.protocol.handshake_exc
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 138, in accept
    ) = self.process_request(request)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 233, in process_request
    raise InvalidUpgrade(
websockets.exceptions.InvalidUpgrade: invalid Connection header: keep-alive
2025-03-04 17:07:39,190 - INFO - connection rejected (426 Upgrade Required)
2025-03-04 17:07:39,190 - ERROR - opening handshake failed
Traceback (most recent call last):
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 356, in conn_handler
    await connection.handshake(
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 207, in handshake
    raise self.protocol.handshake_exc
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 138, in accept
    ) = self.process_request(request)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 233, in process_request
    raise InvalidUpgrade(
websockets.exceptions.InvalidUpgrade: invalid Connection header: keep-alive
2025-03-04 17:07:39,213 - INFO - connection rejected (426 Upgrade Required)
2025-03-04 17:07:39,213 - ERROR - opening handshake failed
Traceback (most recent call last):
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 356, in conn_handler
    await connection.handshake(
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 207, in handshake
    raise self.protocol.handshake_exc
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 138, in accept
    ) = self.process_request(request)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 233, in process_request
    raise InvalidUpgrade(
websockets.exceptions.InvalidUpgrade: invalid Connection header: keep-alive
2025-03-04 17:08:42,090 - INFO - connection rejected (426 Upgrade Required)
2025-03-04 17:08:42,091 - ERROR - opening handshake failed
Traceback (most recent call last):
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 356, in conn_handler
    await connection.handshake(
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 207, in handshake
    raise self.protocol.handshake_exc
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 138, in accept
    ) = self.process_request(request)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 233, in process_request
    raise InvalidUpgrade(
websockets.exceptions.InvalidUpgrade: invalid Connection header: keep-alive
2025-03-04 17:09:31,538 - INFO - connection rejected (426 Upgrade Required)
2025-03-04 17:09:31,539 - ERROR - opening handshake failed
Traceback (most recent call last):
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 356, in conn_handler
    await connection.handshake(
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/asyncio/server.py", line 207, in handshake
    raise self.protocol.handshake_exc
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 138, in accept
    ) = self.process_request(request)
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/var/www/html/.venv/lib/python3.11/site-packages/websockets/server.py", line 233, in process_request
    raise InvalidUpgrade(
websockets.exceptions.InvalidUpgrade: invalid Connection header: keep-alive
